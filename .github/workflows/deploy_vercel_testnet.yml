# Description: Triggers Vercel deployment webhook for testnet
# Included in: NOT included in Generate All Files bundle (deployment only)
# Trigger: Scheduled 30 min after generation workflow (Mon/Thu 09:30 UTC) + manual trigger + push to main
# Note: Push trigger kept as fallback, but won't work with auto-merge due to GITHUB_TOKEN limitation
# Output: Deploys to Vercel testnet environment via webhook

name: Osmosis Front-End Deployment (Testnet)
on:
  schedule:
    - cron: "30 9 * * 1"    # Every Monday at 09:30 UTC (30 min after generation)
    - cron: "30 9 * * 4"    # Every Thursday at 09:30 UTC (30 min after generation)
  workflow_dispatch:  # Allow manual trigger
  push:
    branches:
      - main
    paths:
      - osmo-test-5/generated/frontend/assetlist.json
      - osmo-test-5/generated/frontend/chainlist.json

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history to check file changes

      - name: Check if files have changed
        id: check_changes
        run: |
          # Get last commit time for the target files
          LAST_CHANGE=$(git log -1 --format=%ct --all -- osmo-test-5/generated/frontend/assetlist.json osmo-test-5/generated/frontend/chainlist.json)
          CURRENT_TIME=$(date +%s)
          TIME_DIFF=$((CURRENT_TIME - LAST_CHANGE))

          # If files were modified in the last 2 hours (7200 seconds), deploy
          # This covers the generation workflow (09:00) + 30 min delay (09:30) + buffer
          if [ $TIME_DIFF -lt 7200 ]; then
            echo "Files modified $TIME_DIFF seconds ago - deploying"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "Files last modified $TIME_DIFF seconds ago (>2 hours) - skipping deployment"
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Check latest commit matches API
        if: steps.check_changes.outputs.should_deploy == 'true'
        id: check_commit
        run: |
          MAX_RETRIES=5
          RETRY_COUNT=0
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            LATEST_COMMIT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/commits/main | jq -r '.sha')
            if [ "$LATEST_COMMIT" != "" ]; then
              echo "Latest commit: $LATEST_COMMIT"
              echo "Workflow commit: ${{ github.sha }}"
              if [ "$LATEST_COMMIT" != "${{ github.sha }}" ]; then
                echo "The workflow commit and the latest commit do not match."
                exit 1
              fi
              exit 0
            fi
            RETRY_COUNT=$((RETRY_COUNT+1))
            echo "Failed to fetch latest commit, retrying ($RETRY_COUNT/$MAX_RETRIES)..."
            sleep 5
          done
          echo "Failed to fetch latest commit after $MAX_RETRIES attempts."
          exit 1

      - name: Deploy testnet
        if: steps.check_changes.outputs.should_deploy == 'true'
        run: curl -X POST ${{ secrets.VERCEL_WEBHOOK_DEPLOY_TESTNET }}
