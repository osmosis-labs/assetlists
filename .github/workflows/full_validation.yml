on:
  workflow_dispatch:
    inputs:
      regenerate_chainlist:
        description: 'Regenerate chainlist after validation'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

name: Full Endpoint Validation
jobs:
  full_validation:
    name: Validate All Chain Endpoints
    runs-on: ubuntu-latest

    defaults:
      run:
        shell: bash

    steps:

      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: true

      - name: Git Submodule Update
        run: |
          git submodule update --init --recursive
          git submodule update --recursive --remote

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 19.6.0

      - name: Install dependencies
        run: npm install

      - name: Run Full Validation (All Chains)
        working-directory: ./.github/workflows/utility
        run: node validateEndpoints.mjs fullValidation osmosis

      - name: Regenerate Chainlist with Validated Endpoints
        if: ${{ github.event.inputs.regenerate_chainlist == 'true' }}
        working-directory: ./.github/workflows/utility
        run: node generate_chainlist.mjs

      - name: Check for changes
        id: git-check
        run: |
          git diff --exit-code || echo "changes=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        if: steps.git-check.outputs.changes == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "[AUTO]Full endpoint validation and chainlist update"
          branch: update/full_validation
          title: Full Endpoint Validation Update
          body: |
            **Automated full validation of all chain endpoints**

            This PR includes:
            - Full validation results for all chains
            - Updated chainlist with working backup endpoints promoted to primary
            - Backup endpoint information stored in validation state
          delete-branch: false
